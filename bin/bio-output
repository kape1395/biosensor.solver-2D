#! /usr/bin/env python
# -*- coding: iso-8859-1 -*-

import sys
import re

################################################################################
def error(message):
    sys.stderr.write('\nERROR: ' + message + '\n\n')
    sys.exit(1)


################################################################################
def output_halftime(file):
    sys.stdout.write('# A halftime of a steady state is calculated from: ' + file + '\n')
    inFile = open(file, 'r')

    #  Find last line.
    C_ss = 0.0
    lastLine = ''
    for inLine in inFile:
        if re.search('^#', inLine): continue
        C_ss = float(inLine.split('\t')[2])
        lastLine = inLine
    
    sys.stdout.write('# Assuming stedady state is: ' + re.compile('\t').sub(' ', lastLine))
    C_05 = C_ss / 2;

    #  Find halftime
    inFile.seek(0)
    for inLine in inFile:
        if re.search('^#', inLine): continue
        if C_05 <= float(inLine.split('\t')[2]):
            sys.stdout.write('# Time\tStep\tCurrentDensity\n')
            sys.stdout.write(inLine)
            break

    inFile.close()


################################################################################
def output_steady_state_current(file):
    sys.stdout.write('# A steady state current is calculated from: ' + file + '\n')
    inFile = open(file, 'r')

    lastLine = ''
    for inLine in inFile:
        if re.search('^#', inLine): continue
        lastLine = inLine

    sys.stdout.write('# Time\tStep\tCurrentDensity\n')
    sys.stdout.write(lastLine)
    
    inFile.close()


################################################################################


if len(sys.argv) < 2 :
    error("Command is required")

if sys.argv[1] == 'halftime' or sys.argv[1].startswith("ha") :
    if len(sys.argv) != 3: error('Please specify currentDensityVersusTime file')
    output_halftime(sys.argv[2])

elif sys.argv[1] == 'steadystate' or sys.argv[1].startswith("st") :
    if len(sys.argv) != 3: error('Please specify currentDensityVersusTime file')
    output_steady_state_current(sys.argv[2])

elif sys.argv[1] == 'help' or sys.argv[1].startswith("he") :
    print '#'
    print '# usage: bio-output <subcommand> [arguments]'
    print '# Available subcommands are:'
    print '#     help'
    print '#     halftime <currentDensityFile>'
    print '#     steadystate <currentDensityFile>'
    print '#'

else:
    error('Unknown command, try "bio-output help"')

sys.exit(0)
